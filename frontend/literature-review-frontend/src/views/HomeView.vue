<template>
  <div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
              <el-icon class="text-white text-xl"><Document /></el-icon>
            </div>
            <div>
              <h1 class="text-xl font-bold gradient-text">AI Literature Review</h1>
              <p class="text-xs text-gray-500">æ™ºèƒ½æ–‡çŒ®ç»¼è¿°ç³»ç»Ÿ</p>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <el-button type="primary" :icon="Setting" circle />
            <el-button type="info" :icon="User" circle />
          </div>
        </div>
      </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- å¤´éƒ¨ä»‹ç»åŒºåŸŸ -->
      <div class="text-center mb-12 animate-fade-in">
        <h2 class="text-4xl font-bold text-gray-900 mb-4">
          ğŸ”¬ AI é©±åŠ¨çš„æ–‡çŒ®ç»¼è¿°åŠ©æ‰‹
        </h2>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto mb-8">
          åŸºäºå…ˆè¿›çš„äººå·¥æ™ºèƒ½æŠ€æœ¯ï¼Œä¸ºæ‚¨æä¾›é«˜æ•ˆã€å‡†ç¡®çš„å­¦æœ¯æ–‡çŒ®æ£€ç´¢ã€åˆ†æä¸æ€»ç»“æœåŠ¡
        </p>
        
        <!-- ç‰¹æ€§å¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
          <div class="bg-white rounded-2xl p-6 card-shadow animate-slide-up">
            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-4">
              <el-icon class="text-blue-600 text-2xl"><Search /></el-icon>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">æ™ºèƒ½æ£€ç´¢</h3>
            <p class="text-gray-600">å¤šæ•°æ®æºæ£€ç´¢ï¼Œè¯­ä¹‰ç†è§£ï¼Œç²¾å‡†åŒ¹é…</p>
          </div>
          
          <div class="bg-white rounded-2xl p-6 card-shadow animate-slide-up" style="animation-delay: 0.1s">
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-4">
              <el-icon class="text-green-600 text-2xl"><DataAnalysis /></el-icon>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">AI åˆ†æ</h3>
            <p class="text-gray-600">æ·±åº¦åˆ†ææ–‡çŒ®å†…å®¹ï¼Œæå–å…³é”®ä¿¡æ¯</p>
          </div>
          
          <div class="bg-white rounded-2xl p-6 card-shadow animate-slide-up" style="animation-delay: 0.2s">
            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mx-auto mb-4">
              <el-icon class="text-purple-600 text-2xl"><Document /></el-icon>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">æ™ºèƒ½æ€»ç»“</h3>
            <p class="text-gray-600">ç”Ÿæˆä¸“ä¸šçš„æ–‡çŒ®ç»¼è¿°æŠ¥å‘Š</p>
          </div>
        </div>
      </div>

      <!-- æœç´¢åŒºåŸŸ -->
      <div class="bg-white rounded-3xl p-8 card-shadow mb-8 animate-bounce-in">
        <div class="max-w-4xl mx-auto">
          <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">å¼€å§‹æ‚¨çš„æ–‡çŒ®ç»¼è¿°</h3>
          
          <div class="space-y-6">
            <!-- æœç´¢è¾“å…¥ -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ç ”ç©¶ä¸»é¢˜</label>
              <el-input
                v-model="searchQuery"
                placeholder="è¯·è¾“å…¥æ‚¨çš„ç ”ç©¶ä¸»é¢˜ï¼Œä¾‹å¦‚ï¼šäººå·¥æ™ºèƒ½åœ¨åŒ»ç–—é¢†åŸŸçš„åº”ç”¨"
                size="large"
                class="w-full"
                :prefix-icon="Search"
              />
            </div>

            <!-- é…ç½®é€‰é¡¹ -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">æ•°æ®æº</label>
                <el-select v-model="selectedSources" multiple placeholder="é€‰æ‹©æ•°æ®æº" class="w-full">
                  <el-option label="arXiv" value="arxiv" />
                  <el-option label="Semantic Scholar" value="semantic_scholar" />
                  <el-option label="PubMed" value="pubmed" />
                </el-select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">è®ºæ–‡æ•°é‡</label>
                <el-slider v-model="maxPapers" :min="5" :max="50" :step="5" show-input />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å¹´ä»½èŒƒå›´</label>
                <el-date-picker
                  v-model="yearRange"
                  type="yearrange"
                  placeholder="é€‰æ‹©å¹´ä»½èŒƒå›´"
                  class="w-full"
                />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å…¶ä»–é€‰é¡¹</label>
                <div class="space-y-2">
                  <el-checkbox v-model="retrieveFullText">è·å–å…¨æ–‡</el-checkbox>
                  <el-checkbox v-model="enableAIAnalysis">AI æ·±åº¦åˆ†æ</el-checkbox>
                </div>
              </div>
            </div>

            <!-- æœç´¢æŒ‰é’® -->
            <div class="text-center">
              <el-button
                type="primary"
                size="large"
                :loading="isSearching"
                @click="startSearch"
                class="px-12 py-3 text-lg font-semibold rounded-xl"
              >
                <el-icon class="mr-2"><Search /></el-icon>
                {{ isSearching ? 'æ­£åœ¨æ£€ç´¢...' : 'å¼€å§‹æ£€ç´¢' }}
              </el-button>
            </div>
          </div>
        </div>
      </div>

      <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
      <div v-if="searchResults.length > 0" class="animate-fade-in">
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="bg-white rounded-2xl p-6 card-shadow mb-6">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center">
              <div class="text-3xl font-bold text-blue-600">{{ searchResults.length }}</div>
              <div class="text-sm text-gray-600">æ£€ç´¢åˆ°çš„è®ºæ–‡</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-green-600">{{ fullTextCount }}</div>
              <div class="text-sm text-gray-600">è·å–å…¨æ–‡</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-purple-600">{{ totalKeywords }}</div>
              <div class="text-sm text-gray-600">å…³é”®è¯æ€»æ•°</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-orange-600">{{ uniqueSources }}</div>
              <div class="text-sm text-gray-600">æ•°æ®æº</div>
            </div>
          </div>
        </div>

        <!-- è®ºæ–‡åˆ—è¡¨ -->
        <div class="space-y-4">
          <h3 class="text-xl font-bold text-gray-900 mb-4">æ£€ç´¢ç»“æœ</h3>
          <div
            v-for="(paper, index) in searchResults"
            :key="index"
            class="bg-white rounded-2xl p-6 card-shadow animate-slide-up"
            :style="{ animationDelay: `${index * 0.1}s` }"
          >
            <PaperCard :paper="paper" :index="index + 1" />
          </div>
        </div>
      </div>

      <!-- ç©ºçŠ¶æ€ -->
      <div v-else-if="!isSearching && hasSearched" class="text-center py-12">
        <el-icon class="text-6xl text-gray-400 mb-4"><DocumentRemove /></el-icon>
        <h3 class="text-xl font-semibold text-gray-600 mb-2">æœªæ‰¾åˆ°ç›¸å…³æ–‡çŒ®</h3>
        <p class="text-gray-500">è¯·å°è¯•è°ƒæ•´æœç´¢å…³é”®è¯æˆ–æ‰©å¤§æœç´¢èŒƒå›´</p>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { ElMessage } from 'element-plus'
import {
  Search,
  Document,
  Setting,
  User,
  DataAnalysis,
  DocumentRemove
} from '@element-plus/icons-vue'
import PaperCard from '@/components/PaperCard.vue'

// å“åº”å¼æ•°æ®
const searchQuery = ref('')
const selectedSources = ref(['arxiv', 'semantic_scholar'])
const maxPapers = ref(20)
const yearRange = ref([])
const retrieveFullText = ref(false)
const enableAIAnalysis = ref(true)
const isSearching = ref(false)
const hasSearched = ref(false)
const searchResults = ref([])

// è®¡ç®—å±æ€§
const fullTextCount = computed(() => 
  searchResults.value.filter(paper => paper.fullTextRetrieved).length
)

const totalKeywords = computed(() => 
  searchResults.value.reduce((total, paper) => total + (paper.keywords?.length || 0), 0)
)

const uniqueSources = computed(() => 
  new Set(searchResults.value.map(paper => paper.source)).size
)

// æ–¹æ³•
const startSearch = async () => {
  if (!searchQuery.value.trim()) {
    ElMessage.warning('è¯·è¾“å…¥æœç´¢å…³é”®è¯')
    return
  }

  isSearching.value = true
  hasSearched.value = true

  try {
    // è°ƒç”¨çœŸå®API
    const searchParams = {
      query: searchQuery.value,
      sources: selectedSources.value,
      maxPapers: maxPapers.value,
      yearStart: yearRange.value[0] ? new Date(yearRange.value[0]).getFullYear() : undefined,
      yearEnd: yearRange.value[1] ? new Date(yearRange.value[1]).getFullYear() : undefined,
      retrieveFullText: retrieveFullText.value,
      enableAIAnalysis: enableAIAnalysis.value
    }

    const response = await fetch('http://localhost:8000/api/search', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(searchParams)
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    const result = await response.json()
    searchResults.value = result.papers || []

    ElMessage.success(`æˆåŠŸæ£€ç´¢åˆ° ${searchResults.value.length} ç¯‡ç›¸å…³æ–‡çŒ®`)
  } catch (error) {
    console.error('Search error:', error)
    ElMessage.error('æ£€ç´¢å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ')
    
    // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
    searchResults.value = [
      {
        title: `äººå·¥æ™ºèƒ½åœ¨${searchQuery.value}é¢†åŸŸçš„åº”ç”¨ç ”ç©¶`,
        authors: ['å¼ ä¸‰', 'æå››', 'ç‹äº”'],
        publishedDate: '2024-01-15',
        source: 'arxiv',
        summary: `æœ¬æ–‡æ·±å…¥ç ”ç©¶äº†äººå·¥æ™ºèƒ½æŠ€æœ¯åœ¨${searchQuery.value}é¢†åŸŸçš„æœ€æ–°åº”ç”¨ï¼ŒåŒ…æ‹¬æœºå™¨å­¦ä¹ ã€æ·±åº¦å­¦ä¹ å’Œè‡ªç„¶è¯­è¨€å¤„ç†ç­‰å‰æ²¿æŠ€æœ¯çš„å®é™…åº”ç”¨æ¡ˆä¾‹ã€‚`,
        keywords: ['äººå·¥æ™ºèƒ½', 'æœºå™¨å­¦ä¹ ', 'æ·±åº¦å­¦ä¹ ', searchQuery.value],
        url: 'https://arxiv.org/abs/2401.12345',
        fullTextRetrieved: true
      },
      {
        title: `${searchQuery.value}ä¸­çš„æœºå™¨å­¦ä¹ æ–¹æ³•ç»¼è¿°`,
        authors: ['èµµå…­', 'é’±ä¸ƒ'],
        publishedDate: '2023-12-20',
        source: 'semantic_scholar',
        summary: `æœ¬ç»¼è¿°åˆ†æäº†${searchQuery.value}é¢†åŸŸä¸­æœºå™¨å­¦ä¹ æ–¹æ³•çš„å‘å±•ç°çŠ¶ã€ä¸»è¦æŒ‘æˆ˜å’Œæœªæ¥è¶‹åŠ¿ï¼Œä¸ºç›¸å…³ç ”ç©¶æä¾›äº†é‡è¦å‚è€ƒã€‚`,
        keywords: ['æœºå™¨å­¦ä¹ ', 'æ•°æ®åˆ†æ', 'ç®—æ³•ä¼˜åŒ–'],
        url: 'https://example.com/paper2',
        fullTextRetrieved: false
      }
    ]
    ElMessage.info('å·²åˆ‡æ¢åˆ°æ¼”ç¤ºæ¨¡å¼')
  } finally {
    isSearching.value = false
  }
}
</script>

<style scoped>
.animate-fade-in {
  animation: fadeIn 0.6s ease-out;
}

.animate-slide-up {
  animation: slideUp 0.6s ease-out;
}

.animate-bounce-in {
  animation: bounceIn 0.8s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes bounceIn {
  0% {
    opacity: 0;
    transform: scale(0.3);
  }
  50% {
    opacity: 1;
    transform: scale(1.05);
  }
  70% {
    transform: scale(0.9);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}
</style>
