<template>
  <div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-gradient-to-r from-indigo-600 to-purple-700 rounded-xl flex items-center justify-center">
              <span class="text-white text-xl font-bold">T</span>
            </div>
            <div>
              <h1 class="text-xl font-bold gradient-text">Tsearch</h1>
              <p class="text-xs text-gray-500">Terence's AI Literature Discovery</p>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <el-tooltip content="ç³»ç»Ÿè®¾ç½®">
              <el-button type="primary" :icon="Setting" circle @click="showSettings = true" />
            </el-tooltip>
            <el-tooltip content="ä½¿ç”¨å¸®åŠ©">
              <el-button type="info" :icon="QuestionFilled" circle @click="showHelp = true" />
            </el-tooltip>
            <el-tooltip content="å†å²è®°å½•">
              <el-button type="success" :icon="Clock" circle @click="showHistory = true" />
            </el-tooltip>
          </div>
        </div>
      </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- å¤´éƒ¨ä»‹ç»åŒºåŸŸ -->
      <div class="text-center mb-12 animate-fade-in">
        <h2 class="text-4xl font-bold text-gray-900 mb-4">
          ğŸ”¬ Tsearch - æ™ºèƒ½æ–‡çŒ®å‘ç°å¼•æ“
        </h2>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto mb-8">
          ä¸“ä¸ºTerenceæ‰“é€ çš„AIé©±åŠ¨æ–‡çŒ®æœç´¢å¹³å°ï¼Œè®©å­¦æœ¯ç ”ç©¶æ›´é«˜æ•ˆã€æ›´ç²¾å‡†
        </p>

        <!-- ç‰¹æ€§å¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
          <div class="bg-white rounded-2xl p-6 card-shadow animate-slide-up hover:scale-105 transition-transform">
            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-4">
              <el-icon class="text-blue-600 text-2xl"><Search /></el-icon>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">æ™ºèƒ½æ£€ç´¢</h3>
            <p class="text-gray-600">å¤šæ•°æ®æºæ£€ç´¢ï¼Œè¯­ä¹‰ç†è§£ï¼Œç²¾å‡†åŒ¹é…</p>
          </div>

          <div class="bg-white rounded-2xl p-6 card-shadow animate-slide-up hover:scale-105 transition-transform" style="animation-delay: 0.1s">
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-4">
              <el-icon class="text-green-600 text-2xl"><DataAnalysis /></el-icon>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">AI åˆ†æ</h3>
            <p class="text-gray-600">æ·±åº¦åˆ†ææ–‡çŒ®å†…å®¹ï¼Œæå–å…³é”®ä¿¡æ¯</p>
          </div>

          <div class="bg-white rounded-2xl p-6 card-shadow animate-slide-up hover:scale-105 transition-transform" style="animation-delay: 0.2s">
            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mx-auto mb-4">
              <el-icon class="text-purple-600 text-2xl"><Document /></el-icon>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">æ™ºèƒ½æ€»ç»“</h3>
            <p class="text-gray-600">ç”Ÿæˆä¸“ä¸šçš„æ–‡çŒ®ç»¼è¿°æŠ¥å‘Š</p>
          </div>

          <div class="bg-white rounded-2xl p-6 card-shadow animate-slide-up hover:scale-105 transition-transform" style="animation-delay: 0.3s">
            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center mx-auto mb-4">
              <el-icon class="text-orange-600 text-2xl"><TrendCharts /></el-icon>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">è¶‹åŠ¿åˆ†æ</h3>
            <p class="text-gray-600">è¯†åˆ«ç ”ç©¶çƒ­ç‚¹å’Œå‘å±•è¶‹åŠ¿</p>
          </div>
        </div>
      </div>

      <!-- æœç´¢åŒºåŸŸ -->
      <div class="bg-white rounded-3xl p-8 card-shadow mb-8 animate-bounce-in">
        <div class="max-w-4xl mx-auto">
          <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">å¼€å§‹æ‚¨çš„æ–‡çŒ®ç»¼è¿°</h3>

          <div class="space-y-6">
            <!-- æœç´¢è¾“å…¥ -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ç ”ç©¶ä¸»é¢˜</label>
              <el-input
                v-model="searchQuery"
                placeholder="è¯·è¾“å…¥æ‚¨çš„ç ”ç©¶ä¸»é¢˜ï¼Œä¾‹å¦‚ï¼šäººå·¥æ™ºèƒ½åœ¨åŒ»ç–—é¢†åŸŸçš„åº”ç”¨"
                size="large"
                class="w-full"
                :prefix-icon="Search"
                @keyup.enter="startSearch"
              >
                <template #append>
                  <el-button :icon="Microphone" @click="startVoiceInput" />
                </template>
              </el-input>
              <!-- å¿«é€Ÿæœç´¢å»ºè®® -->
              <div class="mt-2 flex flex-wrap gap-2">
                <el-tag
                  v-for="suggestion in searchSuggestions"
                  :key="suggestion"
                  class="cursor-pointer hover:bg-blue-100"
                  @click="searchQuery = suggestion"
                >
                  {{ suggestion }}
                </el-tag>
              </div>
            </div>

            <!-- é…ç½®é€‰é¡¹ -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">æ•°æ®æº</label>
                <el-select v-model="selectedSources" multiple placeholder="é€‰æ‹©æ•°æ®æº" class="w-full">
                  <el-option label="arXiv" value="arxiv">
                    <span class="flex items-center">
                      <el-icon class="mr-2"><Document /></el-icon>
                      arXiv
                    </span>
                  </el-option>
                  <el-option label="Semantic Scholar" value="semantic_scholar">
                    <span class="flex items-center">
                      <el-icon class="mr-2"><Search /></el-icon>
                      Semantic Scholar
                    </span>
                  </el-option>
                </el-select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">è®ºæ–‡æ•°é‡: {{ maxPapers }}</label>
                <el-slider v-model="maxPapers" :min="5" :max="50" :step="5" show-input />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å¹´ä»½èŒƒå›´</label>
                <el-date-picker
                  v-model="yearRange"
                  type="yearrange"
                  placeholder="é€‰æ‹©å¹´ä»½èŒƒå›´"
                  class="w-full"
                  :shortcuts="yearShortcuts"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å…¶ä»–é€‰é¡¹</label>
                <div class="space-y-2">
                  <el-checkbox v-model="retrieveFullText">
                    <span class="flex items-center">
                      <el-icon class="mr-1"><Download /></el-icon>
                      è·å–å…¨æ–‡
                    </span>
                  </el-checkbox>
                  <el-checkbox v-model="enableAIAnalysis">
                    <span class="flex items-center">
                      <el-icon class="mr-1"><DataAnalysis /></el-icon>
                      AI æ·±åº¦åˆ†æ
                    </span>
                  </el-checkbox>
                </div>
              </div>
            </div>

            <!-- æœç´¢æŒ‰é’® -->
            <div class="text-center">
              <el-button
                type="primary"
                size="large"
                :loading="isSearching"
                @click="startSearch"
                class="px-12 py-3 text-lg font-semibold rounded-xl mr-4"
                :disabled="!searchQuery.trim()"
              >
                <el-icon class="mr-2"><Search /></el-icon>
                {{ isSearching ? 'æ­£åœ¨æ£€ç´¢...' : 'å¼€å§‹æ£€ç´¢' }}
              </el-button>

              <el-button
                v-if="searchResults.length > 0"
                type="success"
                size="large"
                @click="generateReport"
                :loading="isGeneratingReport"
                class="px-8 py-3 text-lg font-semibold rounded-xl"
              >
                <el-icon class="mr-2"><Document /></el-icon>
                {{ isGeneratingReport ? 'ç”Ÿæˆä¸­...' : 'ç”ŸæˆæŠ¥å‘Š' }}
              </el-button>
            </div>
          </div>
        </div>
      </div>

      <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
      <div v-if="searchResults.length > 0" class="animate-fade-in">
        <!-- ç»Ÿè®¡ä¿¡æ¯å’Œæ“ä½œæ  -->
        <div class="bg-white rounded-2xl p-6 card-shadow mb-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900">æ£€ç´¢ç»“æœ</h3>
            <div class="flex items-center space-x-2">
              <el-select v-model="sortBy" placeholder="æ’åºæ–¹å¼" class="w-32">
                <el-option label="ç›¸å…³æ€§" value="relevance" />
                <el-option label="æ—¶é—´" value="date" />
                <el-option label="å¼•ç”¨æ•°" value="citations" />
              </el-select>
              <el-button :icon="Filter" @click="showFilters = !showFilters">ç­›é€‰</el-button>
              <el-button :icon="Download" @click="exportResults">å¯¼å‡º</el-button>
            </div>
          </div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center">
              <div class="text-3xl font-bold text-blue-600">{{ searchResults.length }}</div>
              <div class="text-sm text-gray-600">æ£€ç´¢åˆ°çš„è®ºæ–‡</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-green-600">{{ fullTextCount }}</div>
              <div class="text-sm text-gray-600">è·å–å…¨æ–‡</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-purple-600">{{ totalKeywords }}</div>
              <div class="text-sm text-gray-600">å…³é”®è¯æ€»æ•°</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-orange-600">{{ uniqueSources }}</div>
              <div class="text-sm text-gray-600">æ•°æ®æº</div>
            </div>
          </div>
        </div>

        <!-- ç­›é€‰å™¨ -->
        <div v-if="showFilters" class="bg-white rounded-2xl p-6 card-shadow mb-6 animate-slide-up">
          <h4 class="text-lg font-semibold mb-4">é«˜çº§ç­›é€‰</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ä½œè€…</label>
              <el-input v-model="filterAuthor" placeholder="è¾“å…¥ä½œè€…å§“å" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">å…³é”®è¯</label>
              <el-input v-model="filterKeyword" placeholder="è¾“å…¥å…³é”®è¯" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">æ•°æ®æº</label>
              <el-select v-model="filterSource" placeholder="é€‰æ‹©æ•°æ®æº" class="w-full">
                <el-option label="å…¨éƒ¨" value="" />
                <el-option label="arXiv" value="arxiv" />
                <el-option label="Semantic Scholar" value="semantic_scholar" />
              </el-select>
            </div>
          </div>
        </div>

        <!-- è®ºæ–‡åˆ—è¡¨ -->
        <div class="space-y-4">
          <div
            v-for="(paper, index) in filteredResults"
            :key="index"
            class="bg-white rounded-2xl p-6 card-shadow animate-slide-up hover:scale-[1.02] transition-all duration-300"
            :style="{ animationDelay: `${index * 0.05}s` }"
          >
            <PaperCard :paper="paper" :index="index + 1" @select="togglePaperSelection" />
          </div>
        </div>

        <!-- åˆ†é¡µ -->
        <div v-if="filteredResults.length > pageSize" class="flex justify-center mt-8">
          <el-pagination
            :current-page="currentPage"
            @current-change="handlePageChange"
            :page-size="pageSize"
            :total="filteredResults.length"
            layout="prev, pager, next, jumper"
            class="bg-white rounded-xl p-4 card-shadow"
          />
        </div>
      </div>

      <!-- ç©ºçŠ¶æ€ -->
      <div v-else-if="!isSearching && hasSearched" class="text-center py-12">
        <el-icon class="text-6xl text-gray-400 mb-4"><DocumentRemove /></el-icon>
        <h3 class="text-xl font-semibold text-gray-600 mb-2">æœªæ‰¾åˆ°ç›¸å…³æ–‡çŒ®</h3>
        <p class="text-gray-500 mb-4">è¯·å°è¯•è°ƒæ•´æœç´¢å…³é”®è¯æˆ–æ‰©å¤§æœç´¢èŒƒå›´</p>
        <el-button type="primary" @click="clearSearch">é‡æ–°æœç´¢</el-button>
      </div>

      <!-- åŠ è½½çŠ¶æ€ -->
      <div v-if="isSearching" class="text-center py-12">
        <el-icon class="text-6xl text-blue-500 mb-4 animate-spin"><Loading /></el-icon>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">æ­£åœ¨æ£€ç´¢æ–‡çŒ®...</h3>
        <p class="text-gray-500">{{ searchProgress }}</p>
      </div>
    </div>

    <!-- è®¾ç½®å¯¹è¯æ¡† -->
    <el-dialog v-model="showSettings" title="ç³»ç»Ÿè®¾ç½®" width="600px">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">é»˜è®¤æ•°æ®æº</label>
          <el-checkbox-group v-model="defaultSources">
            <el-checkbox label="arxiv">arXiv</el-checkbox>
            <el-checkbox label="semantic_scholar">Semantic Scholar</el-checkbox>
          </el-checkbox-group>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">é»˜è®¤è®ºæ–‡æ•°é‡</label>
          <el-slider v-model="defaultMaxPapers" :min="5" :max="50" :step="5" show-input />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">è¯­è¨€åå¥½</label>
          <el-select v-model="language" class="w-full">
            <el-option label="ä¸­æ–‡" value="zh" />
            <el-option label="English" value="en" />
          </el-select>
        </div>
      </div>
      <template #footer>
        <el-button @click="showSettings = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="saveSettings">ä¿å­˜è®¾ç½®</el-button>
      </template>
    </el-dialog>

    <!-- å¸®åŠ©å¯¹è¯æ¡† -->
    <el-dialog v-model="showHelp" title="ä½¿ç”¨å¸®åŠ©" width="800px">
      <div class="space-y-4">
        <h4 class="text-lg font-semibold">å¦‚ä½•ä½¿ç”¨</h4>
        <ol class="list-decimal list-inside space-y-2 text-gray-700">
          <li>åœ¨æœç´¢æ¡†ä¸­è¾“å…¥æ‚¨çš„ç ”ç©¶ä¸»é¢˜</li>
          <li>é€‰æ‹©åˆé€‚çš„æ•°æ®æºå’Œæ£€ç´¢å‚æ•°</li>
          <li>ç‚¹å‡»"å¼€å§‹æ£€ç´¢"æŒ‰é’®</li>
          <li>æŸ¥çœ‹æ£€ç´¢ç»“æœå¹¶è¿›è¡Œç­›é€‰</li>
          <li>ç”Ÿæˆç»¼è¿°æŠ¥å‘Š</li>
        </ol>

        <h4 class="text-lg font-semibold mt-6">æœç´¢æŠ€å·§</h4>
        <ul class="list-disc list-inside space-y-2 text-gray-700">
          <li>ä½¿ç”¨å…·ä½“çš„å…³é”®è¯ç»„åˆ</li>
          <li>å°è¯•ä¸åŒçš„åŒä¹‰è¯</li>
          <li>ä½¿ç”¨è‹±æ–‡å…³é”®è¯å¯èƒ½è·å¾—æ›´å¥½çš„ç»“æœ</li>
          <li>é€‚å½“è°ƒæ•´å¹´ä»½èŒƒå›´</li>
        </ul>
      </div>
    </el-dialog>

    <!-- å†å²è®°å½•å¯¹è¯æ¡† -->
    <el-dialog v-model="showHistory" title="æœç´¢å†å²" width="600px">
      <div v-if="searchHistory.length === 0" class="text-center py-8 text-gray-500">
        æš‚æ— æœç´¢å†å²
      </div>
      <div v-else class="space-y-3">
        <div
          v-for="(item, index) in searchHistory"
          :key="index"
          class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer"
          @click="loadHistoryItem(item)"
        >
          <div>
            <div class="font-medium">{{ item.query }}</div>
            <div class="text-sm text-gray-500">{{ item.date }} Â· {{ item.resultCount }} ç¯‡è®ºæ–‡</div>
          </div>
          <el-button type="danger" size="small" :icon="Delete" circle @click.stop="removeHistoryItem(index)" />
        </div>
      </div>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, watch } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  Search,
  Document,
  Setting,
  QuestionFilled,
  Clock,
  DataAnalysis,
  DocumentRemove,
  Loading,
  TrendCharts,
  Microphone,
  Download,
  Filter,
  Delete
} from '@element-plus/icons-vue'
import PaperCard from '../components/PaperCard.vue'

// å®šä¹‰Paperæ¥å£
interface Paper {
  title: string
  authors: string[]
  publishedDate: string
  source: string
  summary: string
  keywords?: string[]
  url?: string
  pdfUrl?: string
  fullTextRetrieved?: boolean
  citations?: number
}

// å®šä¹‰æœç´¢å†å²é¡¹æ¥å£
interface SearchHistoryItem {
  query: string
  date: string
  resultCount: number
  params: {
    sources: string[]
    maxPapers: number
    retrieveFullText: boolean
    enableAIAnalysis: boolean
    yearStart?: number
    yearEnd?: number
  }
}

// å“åº”å¼æ•°æ®
const searchQuery = ref('')
const selectedSources = ref(['arxiv', 'semantic_scholar'])
const maxPapers = ref(20)
const yearRange = ref<Date[]>([])
const retrieveFullText = ref(false)
const enableAIAnalysis = ref(true)
const isSearching = ref(false)
const isGeneratingReport = ref(false)
const hasSearched = ref(false)
const searchResults = ref<Paper[]>([])
const searchProgress = ref('')

// UI çŠ¶æ€
const showSettings = ref(false)
const showHelp = ref(false)
const showHistory = ref(false)
const showFilters = ref(false)

// ç­›é€‰å’Œæ’åº
const sortBy = ref('relevance')
const filterAuthor = ref('')
const filterKeyword = ref('')
const filterSource = ref('')
const currentPage = ref(1)
const pageSize = ref(10)

// è®¾ç½®
const defaultSources = ref(['arxiv', 'semantic_scholar'])
const defaultMaxPapers = ref(20)
const language = ref('zh')

// æœç´¢å†å²
const searchHistory = ref<SearchHistoryItem[]>([])

// æœç´¢å»ºè®®
const searchSuggestions = ref([
  'äººå·¥æ™ºèƒ½åœ¨åŒ»ç–—é¢†åŸŸçš„åº”ç”¨',
  'æœºå™¨å­¦ä¹ ç®—æ³•ä¼˜åŒ–',
  'æ·±åº¦å­¦ä¹ å›¾åƒè¯†åˆ«',
  'è‡ªç„¶è¯­è¨€å¤„ç†æŠ€æœ¯',
  'åŒºå—é“¾æŠ€æœ¯åº”ç”¨',
  'é‡å­è®¡ç®—å‘å±•'
])

// å¹´ä»½å¿«æ·é€‰é¡¹
const yearShortcuts = [
  {
    text: 'æœ€è¿‘ä¸€å¹´',
    value: () => [new Date(new Date().getFullYear() - 1, 0, 1), new Date()]
  },
  {
    text: 'æœ€è¿‘ä¸‰å¹´',
    value: () => [new Date(new Date().getFullYear() - 3, 0, 1), new Date()]
  },
  {
    text: 'æœ€è¿‘äº”å¹´',
    value: () => [new Date(new Date().getFullYear() - 5, 0, 1), new Date()]
  }
]

// è®¡ç®—å±æ€§
const fullTextCount = computed(() =>
  searchResults.value.filter(paper => paper.fullTextRetrieved).length
)

const totalKeywords = computed(() =>
  searchResults.value.reduce((total, paper) => total + (paper.keywords?.length || 0), 0)
)

const uniqueSources = computed(() =>
  new Set(searchResults.value.map(paper => paper.source)).size
)

const filteredResults = computed(() => {
  let results = [...searchResults.value]

  // åº”ç”¨ç­›é€‰
  if (filterAuthor.value) {
    results = results.filter(paper =>
      paper.authors.some((author: string) =>
        author.toLowerCase().includes(filterAuthor.value.toLowerCase())
      )
    )
  }

  if (filterKeyword.value) {
    results = results.filter(paper =>
      paper.keywords?.some((keyword: string) =>
        keyword.toLowerCase().includes(filterKeyword.value.toLowerCase())
      ) || paper.title.toLowerCase().includes(filterKeyword.value.toLowerCase())
    )
  }

  if (filterSource.value) {
    results = results.filter(paper => paper.source === filterSource.value)
  }

  // åº”ç”¨æ’åº
  if (sortBy.value === 'date') {
    results.sort((a, b) => new Date(b.publishedDate).getTime() - new Date(a.publishedDate).getTime())
  } else if (sortBy.value === 'citations') {
    results.sort((a, b) => (b.citations || 0) - (a.citations || 0))
  }

  return results
})

// æ–¹æ³•
const startSearch = async () => {
  if (!searchQuery.value.trim()) {
    ElMessage.warning('è¯·è¾“å…¥æœç´¢å…³é”®è¯')
    return
  }

  isSearching.value = true
  hasSearched.value = true
  searchProgress.value = 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...'

  try {
    const requestData = {
      query: searchQuery.value,
      sources: selectedSources.value,
      maxPapers: maxPapers.value,
      yearStart: yearRange.value?.[0]?.getFullYear(),
      yearEnd: yearRange.value?.[1]?.getFullYear(),
      retrieveFullText: retrieveFullText.value,
      enableAIAnalysis: enableAIAnalysis.value
    }

    searchProgress.value = 'æ­£åœ¨æ£€ç´¢æ–‡çŒ®...'

    const response = await fetch('http://localhost:8000/api/search', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestData)
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    const data = await response.json()
    searchResults.value = data.papers || []

    // ä¿å­˜åˆ°æœç´¢å†å²
    const historyItem: SearchHistoryItem = {
      query: searchQuery.value,
      date: new Date().toLocaleDateString('zh-CN'),
      resultCount: searchResults.value.length,
      params: requestData
    }
    searchHistory.value.unshift(historyItem)
    if (searchHistory.value.length > 10) {
      searchHistory.value = searchHistory.value.slice(0, 10)
    }

    ElMessage.success(`æ£€ç´¢å®Œæˆï¼æ‰¾åˆ° ${searchResults.value.length} ç¯‡ç›¸å…³è®ºæ–‡`)

  } catch (error) {
    console.error('Search error:', error)
    ElMessage.error('æ£€ç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•')
  } finally {
    isSearching.value = false
    searchProgress.value = ''
  }
}

const generateReport = async () => {
  if (searchResults.value.length === 0) {
    ElMessage.warning('æ²¡æœ‰å¯ç”¨çš„è®ºæ–‡æ•°æ®')
    return
  }

  isGeneratingReport.value = true

  try {
    const response = await fetch('http://localhost:8000/api/generate-report', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        papers: searchResults.value,
        title: `${searchQuery.value} - æ–‡çŒ®ç»¼è¿°æŠ¥å‘Š`
      })
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    const data = await response.json()

    // æ˜¾ç¤ºæŠ¥å‘Šå†…å®¹
    ElMessageBox.alert(data.report, 'ç»¼è¿°æŠ¥å‘Š', {
      dangerouslyUseHTMLString: false,
      customClass: 'report-dialog'
    })

  } catch (error) {
    console.error('Report generation error:', error)
    ElMessage.error('æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
  } finally {
    isGeneratingReport.value = false
  }
}

const startVoiceInput = () => {
  ElMessage.info('è¯­éŸ³è¾“å…¥åŠŸèƒ½å¼€å‘ä¸­...')
}

const exportResults = () => {
  const dataStr = JSON.stringify(searchResults.value, null, 2)
  const dataBlob = new Blob([dataStr], { type: 'application/json' })
  const url = URL.createObjectURL(dataBlob)
  const link = document.createElement('a')
  link.href = url
  link.download = `literature_search_${new Date().toISOString().split('T')[0]}.json`
  link.click()
  URL.revokeObjectURL(url)
  ElMessage.success('ç»“æœå·²å¯¼å‡º')
}

const clearSearch = () => {
  searchQuery.value = ''
  searchResults.value = []
  hasSearched.value = false
}

const togglePaperSelection = (paper: Paper) => {
  // å®ç°è®ºæ–‡é€‰æ‹©åŠŸèƒ½
  ElMessage.info('è®ºæ–‡é€‰æ‹©åŠŸèƒ½å¼€å‘ä¸­...')
}

const saveSettings = () => {
  selectedSources.value = [...defaultSources.value]
  maxPapers.value = defaultMaxPapers.value
  showSettings.value = false
  ElMessage.success('è®¾ç½®å·²ä¿å­˜')
}

const loadHistoryItem = (item: SearchHistoryItem) => {
  searchQuery.value = item.query
  selectedSources.value = item.params.sources
  maxPapers.value = item.params.maxPapers
  retrieveFullText.value = item.params.retrieveFullText
  enableAIAnalysis.value = item.params.enableAIAnalysis
  showHistory.value = false
  ElMessage.success('å·²åŠ è½½å†å²æœç´¢')
}

const removeHistoryItem = (index: number) => {
  searchHistory.value.splice(index, 1)
  ElMessage.success('å·²åˆ é™¤å†å²è®°å½•')
}

const handlePageChange = (page: number) => {
  currentPage.value = page
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  // åŠ è½½ä¿å­˜çš„è®¾ç½®
  const savedSettings = localStorage.getItem('literatureReviewSettings')
  if (savedSettings) {
    const settings = JSON.parse(savedSettings)
    defaultSources.value = settings.defaultSources || ['arxiv', 'semantic_scholar']
    defaultMaxPapers.value = settings.defaultMaxPapers || 20
    language.value = settings.language || 'zh'
  }

  // åŠ è½½æœç´¢å†å²
  const savedHistory = localStorage.getItem('searchHistory')
  if (savedHistory) {
    searchHistory.value = JSON.parse(savedHistory)
  }
})

// ç›‘å¬è®¾ç½®å˜åŒ–å¹¶ä¿å­˜
watch([defaultSources, defaultMaxPapers, language], () => {
  const settings = {
    defaultSources: defaultSources.value,
    defaultMaxPapers: defaultMaxPapers.value,
    language: language.value
  }
  localStorage.setItem('literatureReviewSettings', JSON.stringify(settings))
}, { deep: true })

// ç›‘å¬æœç´¢å†å²å˜åŒ–å¹¶ä¿å­˜
watch(searchHistory, () => {
  localStorage.setItem('searchHistory', JSON.stringify(searchHistory.value))
}, { deep: true })
</script>

<style scoped>
/* ç»„ä»¶ç‰¹å®šæ ·å¼ */
.transition-transform {
  transition: transform 0.3s ease;
}

.hover\:scale-105:hover {
  transform: scale(1.05);
}

.hover\:scale-\[1\.02\]:hover {
  transform: scale(1.02);
}

/* æŠ¥å‘Šå¯¹è¯æ¡†æ ·å¼ */
:deep(.report-dialog) {
  max-width: 80vw;
  max-height: 80vh;
}

:deep(.report-dialog .el-message-box__content) {
  max-height: 60vh;
  overflow-y: auto;
  white-space: pre-wrap;
  font-family: monospace;
}

/* åŠ¨ç”»ä¼˜åŒ– */
.animate-spin {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
</style>
